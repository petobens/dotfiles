#!/usr/bin/env python
"""Create GTK confirmation dialog."""
import subprocess
from subprocess import Popen

import gi
import i3ipc

gi.require_version('Gtk', '3.0')

if True:
    from gi.repository import Gtk, Pango
    from PIL import ImageFont


FONT = 'NotoSans-Regular.ttf'
FONT_SIZE = 11


def _sh_no_block(cmd, *args, **kwargs):
    if isinstance(cmd, str):
        cmd = cmd.split()
    return subprocess.Popen(cmd, *args, **kwargs)


def _sh(cmd, *args, **kwargs):
    res, _ = _sh_no_block(cmd, *args, stdout=subprocess.PIPE, **kwargs).communicate()
    return res


def confirmation_dialog(title, msg, action, shell=False):
    """Create confirmation dialog that triggers an action."""
    i3 = i3ipc.Connection()
    ws = i3.get_tree().find_focused().workspace()
    is_hidpi = ws.ipc_data['output'] == 'eDP1'
    nr_monitors = int(
        [
            line.decode('ascii').split()
            for line in _sh('xrandr --listactivemonitors').splitlines()
        ][0][-1]
    )
    fsize = FONT_SIZE
    if nr_monitors > 1 and is_hidpi:
        fsize = FONT_SIZE * 2

    win = Gtk.Window()
    win.connect('destroy', Gtk.main_quit)
    dialog = Gtk.Dialog(parent=win)

    font = ImageFont.truetype(FONT, fsize)
    w, _ = font.getsize(msg)
    actual_w = w + 80
    actual_h = 110
    final_w = actual_w * 2 if is_hidpi else actual_w
    final_h = actual_h * 2 if is_hidpi else actual_h
    dialog.set_default_size(final_w, final_h)

    dialog.set_property('title', title)
    dialog.add_buttons(
        Gtk.STOCK_OK, Gtk.ResponseType.OK, Gtk.STOCK_CANCEL, Gtk.ResponseType.CANCEL
    )
    dialog.action_area.set_property('halign', Gtk.Align.CENTER)

    label = Gtk.Label()
    label.override_font(Pango.FontDescription(f'Noto Sans {fsize}'))
    label.set_text(msg)
    box = dialog.get_content_area()
    box.add(label)
    dialog.show_all()

    res = dialog.run()
    if res == Gtk.ResponseType.OK:
        Popen(action, shell=shell)
    elif res == Gtk.ResponseType.CANCEL:
        pass
    dialog.destroy()
    quit()


if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument('--title', '-t', required=True)
    parser.add_argument('--msg', '-m', required=True)
    parser.add_argument('--action', '-a', required=True)
    parser.add_argument('--shell', dest='shell', action='store_true')
    parser.add_argument('--no-shell', dest='shell', action='store_false')
    parser.set_defaults(shell=False)
    parsed_args = parser.parse_args()

    if isinstance(parsed_args.action, str) and not parsed_args.shell:
        parsed_args.action = parsed_args.action.split()

    confirmation_dialog(
        parsed_args.title, parsed_args.msg, parsed_args.action, parsed_args.shell
    )
    Gtk.main()
