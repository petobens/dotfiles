# Preamble {{{

# Define some keys as variables (super and alt)
set $mod Mod4
set $alt Mod1

# Variable to disable startup notifications (to be used with scripts)
set $nexec exec --no-startup-id

# Restart i3 inplace (preserving layout): this also reloads the config file
bindsym $mod+Control+r restart

# }}}
# Window handling {{{

# Make all windows floating by default (i'm used to that)
for_window [class="^.*"] floating enable

# Allow floating windows to have any size
floating_maximum_size -1 x -1

# Move a floating window with the mouse and pressing mod
floating_modifier $mod

# Toggle floating and tiling
bindsym $mod+f floating toggle

# Full screen
bindsym $mod+Control+e fullscreen toggle

# Floating resizing (spanning)
# FIXME: Keep focus
bindsym $mod+Up $nexec $HOME/.config/i3/resize.py Full
bindsym $mod+Left $nexec $HOME/.config/i3/resize.py Left
#  FIXME: This one doesn't work quite well
bindsym $mod+Right $nexec $HOME/.config/i3/resize.py Right
bindsym $mod+Control+Up $nexec $HOME/.config/i3/resize.py Top
bindsym $mod+Control+Down $nexec $HOME/.config/i3/resize.py Bottom
bindsym $mod+Control+1 $nexec $HOME/.config/i3/resize.py 'Top Left'
bindsym $mod+Control+2 $nexec $HOME/.config/i3/resize.py 'Top Right'
bindsym $mod+Control+3 $nexec $HOME/.config/i3/resize.py 'Bottom Left'
bindsym $mod+Control+4 $nexec $HOME/.config/i3/resize.py 'Bottom Right'
bindsym $mod+Control+5 $nexec $HOME/.config/i3/resize.py Center

# Resize
bindsym $mod+h resize grow left 10 px or 5 ppt
bindsym $mod+$alt+h resize shrink right 10 px or 5 ppt
bindsym $mod+l resize grow right 10 px or 5 ppt
bindsym $mod+$alt+l resize shrink left 10 px or 5 ppt
bindsym $mod+k resize grow up 10 px or 5 ppt
bindsym $mod+$alt+j resize shrink up 10 px or 5 ppt
bindsym $mod+j resize grow down 10 px or 5 ppt
bindsym $mod+$alt+k resize shrink down 10 px or 5 ppt

#  }}}
#  Multiple monitors and workspaces {{{

# Define names for default workspaces
set $ws1 "1"
set $ws2 "2"
set $ws3 "3"
set $ws4 "4"
set $ws5 "5"
set $ws6 "6"

# Switch (and created if needed) workspace
bindsym $mod+1 workspace $ws1
bindsym $mod+2 workspace $ws2
bindsym $mod+3 workspace $ws3
bindsym $mod+4 workspace $ws4
bindsym $mod+5 workspace $ws5
bindsym $mod+6 workspace $ws6

# Move focused container to specific workspace and switch focus to that
# container
bindsym $mod+Shift+1 move container to workspace $ws1; workspace $ws1
bindsym $mod+Shift+2 move container to workspace $ws2; workspace $ws2
bindsym $mod+Shift+3 move container to workspace $ws3; workspace $ws3
bindsym $mod+Shift+4 move container to workspace $ws4; workspace $ws4
bindsym $mod+Shift+5 move container to workspace $ws5; workspace $ws5
bindsym $mod+Shift+6 move container to workspace $ws6; workspace $ws6

# Toggle dual monitor and define those monitors
#  FIXME: This completely breaks the window and polybar layout
bindsym $mod+Control+Return $nexec dual && i3-msg restart

# Move window (container) in monitor (output) direction and switch focus
# TODO: Resize to correct split instead of full screen
bindsym $mod+Control+Right move container to output right; focus output right; \
    $nexec $HOME/.config/i3/resize.py Full
bindsym $mod+Control+Left move container to output left; focus output left; \
    $nexec $HOME/.config/i3/resize.py Full

# Assign workspaces to specific monitors (use `xrandr --current` to see which
# are available). Even on primary and odds on secondary
set $internal "eDP-1"
set $external "DP-1"
workspace $ws1 output $internal
workspace $ws2 output $external
workspace $ws3 output $interal
workspace $ws4 output $external
workspace $ws5 output $internal
workspace $ws6 output $external

# Focus next monitor (with wrapping): this switches mouse cursor two
bindsym $alt+grave focus output right

# }}}
# Run or activate apps and rules {{{

# Rofi (application launcher / switcher)
bindsym $alt+Tab $nexec $HOME/.config/i3/tab_switcher.sh
bindsym $mod+p $nexec "rofi -combi-modi drun,run -show combi"

# Run/Launch or focus (in specific workspace)
# Note: i) we use the i3-msg hack to open the window in a specific workspace but
# focus it if it's already opened in another one.
# See: https://github.com/open-dynaMIX/raiseorlaunch/issues/15
# ii) we use marks terminal to avoid focusing on other windows of the same class
# https://github.com/open-dynaMIX/raiseorlaunch/issues/17

# TODO: Open some of these windows maximised?
# WS1 (foreground programs)
bindsym $mod+Control+i $nexec raiseorlaunch -c Chromium -e \
    "--no-startup-id i3-msg workspace $ws1 && chromium" -m browser
bindsym $mod+Control+l $nexec raiseorlaunch -c Slack -e \
    "--no-startup-id i3-msg workspace $ws1 && slack"
bindsym $mod+Control+s $nexec raiseorlaunch -c Skype -e \
    "--no-startup-id i3-msg workspace $ws1 && skypeforlinux"
bindsym $mod+Control+x $nexec raiseorlaunch -c 'libreoffice-calc' -e \
    "--no-startup-id i3-msg workspace $ws1 && libreoffice --calc"
bindsym $mod+Control+w $nexec raiseorlaunch -c 'libreoffice-writer' -e \
    "--no-startup-id i3-msg workspace $ws1 && libreoffice --writer"
# WS2 (terminal and those interacting with it)
bindsym $mod+Control+c $nexec raiseorlaunch -c Alacritty -e \
    "--no-startup-id i3-msg workspace $ws2 && alacritty" -m terminal
bindsym $mod+Control+p $nexec raiseorlaunch -c Zathura -e \
    "--no-startup-id i3-msg workspace $ws2 && zathura"
bindsym $mod+Control+v $nexec raiseorlaunch -c feh  -e \
    "--no-startup-id i3-msg workspace $ws2 && feh"
bindsym $mod+Control+g $nexec raiseorlaunch -c Peek -e \
    "--no-startup-id i3-msg workspace $ws2 && peek"
# WS3 (background programs)
bindsym $mod+Control+m $nexec raiseorlaunch -c Spotify -e \
    "--no-startup-id i3-msg workspace $ws3 && spotify --force-device-scale-factor=2"
bindsym $mod+Control+t $nexec raiseorlaunch -c Thunderbird -e \
    "--no-startup-id i3-msg workspace $ws3 && thunderbird"
bindsym $mod+Control+u $nexec raiseorlaunch -c Transmission-gtk -e \
    "--no-startup-id i3-msg workspace $ws3 && transmission-gtk"
# Note: to have calendar desktop notifications we must enable the following
# flag: `chrome://flags/#enable-native-notifications`.
# See: https://github.com/dunst-project/dunst/issues/375
bindsym $mod+Control+a $nexec raiseorlaunch -c Chromium -e \
    "--no-startup-id i3-msg workspace $ws3 && chromium --new-window https://calendar.google.com/calendar/r" -m cal

# Standalone terminal apps in floating window in the current workspace
bindsym $mod+Return $nexec alacritty -d 100 25
bindsym $mod+Control+n $nexec raiseorlaunch -t 'numbers' -e \
    'alacritty -t numbers -d 100 25 -e sh -c "i3-msg -q move position center && ipython3"'
bindsym $mod+Control+f $nexec raiseorlaunch -t 'finder' -e \
    'alacritty -t finder -d 100 25 -e sh -c "i3-msg -q move position center && ranger"'
bindsym $mod+Control+d $nexec raiseorlaunch -t 'Downloads' -e \
    'alacritty -t Downloads -d 100 25 -e sh -c "i3-msg -q move position center && ranger ~/Downloads"'
bindsym $mod+Control+h $nexec raiseorlaunch -t 'htop' -e \
    'alacritty -t htop -d 100 25 -e sh -c "i3-msg -q move position center && htop"'
bindsym $mod+Control+o $nexec raiseorlaunch -t 'OneDrive' -e \
    'alacritty -t OneDrive -d 150 30 -e sh -c "i3-msg -q move position center && less +F $HOME/onedrive.log"'

# Other rules (use `xprop | grep -i 'class'` to get the class)
for_window [window_type="splash"] floating enable, move position center
for_window [class="^(Pavucontrol|Connman-gtk)$"] floating enable, \
    resize set 50ppt 40ppt, move position center
for_window [class="^(Peek)$"] $nexec $HOME/.config/i3/resize.py Center

# }}}
#  Spotify and volume {{{

bindsym $mod+Shift+p $nexec playerctl --player spotify play-pause
bindsym $mod+Shift+j $nexec playerctl --player spotify next
bindsym $mod+Shift+k $nexec playerctl --player spotify previous
bindsym $mod+Shift+t $nexec $HOME/.config/i3/spotify_track.py

bindsym $mod+Shift+plus $nexec "pactl set-sink-mute @DEFAULT_SINK@ false ; pactl set-sink-volume @DEFAULT_SINK@ +10%"
bindsym $mod+Shift+minus $nexec pactl set-sink-volume @DEFAULT_SINK@ -10%
bindsym $mod+Shift+m $nexec pactl set-sink-mute @DEFAULT_SINK@ toggle
bindsym $mod+Shift+v exec pavucontrol

# }}}
# Theme and fonts {{{

# Disable title bar
font pango:Noto Sans 0

# Set window border width
for_window [class="^.*"] border pixel 2

# Theme
set $bg #24272e
set $border #282c34
set $fg #abb2bf
set $fg_high #d0d0d0
set $fg_urg #e06c75
#                       Border  Background Text     Indicator Child border
client.focused          $border $bg        $fg_high $fg       $border
client.focused_inactive $border $bg        $fg      $fg       $border
client.unfocused        $border $bg        $fg      $fg       $border
client.urgent           $border $bg        $fg_urg  $fg       $border
client.placeholder      $border $bg        $fg      $fg       $border
client.background       $border

# }}}
# Miscellaneous {{{

# Screenshots
bindsym Print $nexec shots full
bindsym $mod+Shift+8 $nexec shots selection
bindsym $mod+Shift+9 $nexec shots active

# Kill focused window (as in mac); note that this quit apps that are minimized
# to sys tray (in this cases, such as slack, use ctrl-q to actually kill them)
bindsym $mod+q kill

# Shutdown, restart and lock
bindsym $mod+Shift+s $nexec gtk_dialog -t "Power Management" \
    -m "Do you want to poweroff?" -a "systemctl poweroff"
bindsym $mod+Shift+r $nexec gtk_dialog -t "Power Management" \
    -m "Do you want to reboot?" -a "systemctl reboot"
bindsym $mod+Shift+l $nexec $HOME/.config/i3/i3lock_fancy.sh

# Screen brightness
bindsym $mod+Shift+Right exec xbacklight -inc 10
bindsym $mod+Shift+Left exec xbacklight -dec 10

# Eject mounted media (usb drives)
bindsym $mod+Shift+e $nexec gtk_dialog -t "Media Management" \
    -m "Do you want to eject media drive?" -a "udiskie-umount -a"

# Trash Can
bindsym $mod+Control+b $nexec alacritty -t 'Trash Can'  -d 100 25 -e sh -c \
    "i3-msg -q move position center && trash-list | less"
for_window [title="^Trash Can$"] floating enable
bindsym $mod+Shift+b $nexec gtk_dialog \
    -t 'Trash' -m 'Do you want to empty the Trash?' --shell \
    -a "trash-empty & dunstify -t 2500 -i trashindicator 'Trash Can emptied!'"

# }}}
# Startup {{{

# Use exec_always to relaunch polybar when restarting i3
exec_always --no-startup-id $HOME/.config/polybar/launch.py

# }}}
